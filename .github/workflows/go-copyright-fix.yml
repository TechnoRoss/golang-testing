name: Go Copyright Auto-Fixer

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check-and-fix-copyright:
    name: Check and Fix Go File Copyrights
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Year Variable
        run: echo "YEAR=$(date +%Y)" >> $GITHUB_ENV

      - name: Check and Fix Go file copyrights
        run: |
          ERROR=0
          CURRENT_YEAR=$YEAR

          # Find all Go files
          for file in $(find . -type f -name "*.go"); do
            # If file contains a copyright with an older year, update it in-place
            if grep -E -q "// Copyright ¬© [0-9]{4} Ping Identity Corporation" "$file"; then
              echo "üîÑ Updating copyright year in: $file"
              sed -i -E "s|(// Copyright ¬© )([0-9]{4})( Ping Identity Corporation)|\1$CURRENT_YEAR\3|" "$file"
              ERROR=1
            # If file does NOT contain a copyright at all, insert it before the package declaration
            elif ! grep -q "// Copyright ¬©" "$file"; then
              echo "‚ö†Ô∏è Adding missing copyright to: $file"
              TEMP_FILE=$(mktemp)

              # Insert copyright before package declaration
              awk -v header="// Copyright ¬© $CURRENT_YEAR Ping Identity Corporation\n" '
                NR==1 { print header }
                { print }
              ' "$file" > "$TEMP_FILE"

              mv "$TEMP_FILE" "$file"
              ERROR=1
            fi
          done

          if [[ $ERROR -eq 0 ]]; then
            echo "‚úÖ All Go files have the correct copyright year."
          else
            echo "üîß Changes made. Committing..."
          fi

      - name: Commit and push changes
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Extract the source branch (PR branch or main branch)
          BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}

          echo "üîç Determined source branch: $BRANCH_NAME"

          git fetch origin $BRANCH_NAME
          git checkout $BRANCH_NAME

          git add .
          git commit -m "pingbot: Updated copyright year to $YEAR or added copyright across all Go files" || exit 0
          git push origin $BRANCH_NAME
